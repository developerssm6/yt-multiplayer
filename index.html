<!-- Save as index.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>YouTube Playlist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.5.13/dist/vuetify.min.css" rel="stylesheet" />
    <style>
        html,
        body,
        #app {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }

        .hoverable-card {
            cursor: pointer;
            transition: transform 0.2s;
            aspect-ratio: 1 / 1;
        }

        .hoverable-card {
            cursor: pointer;
            transition: transform 0.2s;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }


        .hoverable-card:hover {
            transform: scale(1.02);
        }

        #yt-player {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="app">
        <v-app>
            <v-layout>
                <!-- App Bar -->
                <v-app-bar color="teal-darken-4" image="https://picsum.photos/1920/1080?random">
                    <template v-slot:image>
                        <v-img gradient="to top right, rgba(19,84,122,.8), rgba(128,208,199,.8)"></v-img>
                    </template>
                    <v-app-bar-title>YouTube Playlist</v-app-bar-title>
                    <v-text-field v-model="url" label="Paste URL" hide-details="auto" @keyup.enter="add"
                        variant="outlined" density="compact" prepend-inner-icon="mdi-youtube" class="mx-4"
                        style="max-width: 250px;"></v-text-field>
                    <v-btn icon @click="add" title="Add">âž•</v-btn>
                    <v-btn icon @click="toggleTheme" title="Theme">ðŸŽ¨</v-btn>
                    <v-btn icon @click="shuffle" title="Shuffle">ðŸ”€</v-btn>
                    <v-btn icon @click="mute" title="Mute">{{ muted ? 'ðŸ”‡' : 'ðŸ”Š' }}</v-btn>
                    <v-btn icon @click="exportList" title="Export">ðŸ“¤</v-btn>
                    <v-btn icon @click="importing = true" title="Import">ðŸ“¥</v-btn>
                </v-app-bar>

                <!-- Main Content -->
                <v-main>
                    <v-container fluid>


                        <draggable v-model="list" item-key="url" handle=".drag" class="d-flex flex-wrap">
                            <template #item="{ element, index }">
                                <v-card class="ma-2 d-flex flex-column justify-space-between" min-width="240px"
                                    min-height="240" elevation="3">

                                    <!-- Image (click to play) -->
                                    <v-img :src="thumb(element.url)" aspect-ratio="1" cover @click="play(element)"
                                        class="hoverable-card"></v-img>

                                    <!-- Title -->
                                    <v-card-title class="text-truncate px-2 pt-2 pb-1"
                                        style="font-size: 0.8rem; height: 36px;">
                                        {{ element.title || element.id }}
                                    </v-card-title>

                                    <!-- Actions -->
                                    <v-card-actions class="px-2 py-1 d-flex justify-space-between"
                                        style="min-height: 36px;">
                                        <span class="drag" style="cursor: move; color: grey;">â ¿</span>
                                        <v-btn icon size="x-small"
                                            @click.stop="element.favorite = !element.favorite; save()">
                                            <span>{{ element.favorite ? 'â˜…' : 'â˜†' }}</span>
                                        </v-btn>
                                        <v-btn icon size="x-small" color="red"
                                            @click.stop="list.splice(index, 1); save()">
                                            ðŸ—‘
                                        </v-btn>
                                    </v-card-actions>
                                </v-card>
                            </template>
                        </draggable>



                    </v-container>
                </v-main>
            </v-layout>

            <!-- Floating Player -->
            <v-sheet v-if="current"
                :style="expanded 
          ? 'position: fixed; inset: 0; z-index: 999; background: black;' 
          : 'position: fixed; bottom: 16px; right: 16px; width: 320px; height: 180px; z-index: 998; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.5); background: black;'">
                <div id="yt-player"></div>
                <v-row v-if="expanded" class="pa-2 justify-end"
                    style="position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.5);">
                    <v-btn variant="text" @click="expanded = false" color="blue">Min</v-btn>
                    <v-btn variant="text" color="red" @click="close">Close</v-btn>
                </v-row>
            </v-sheet>

            <!-- Import Dialog -->
            <v-dialog v-model="importing" width="600">
                <v-card>
                    <v-card-title>Import Playlist JSON</v-card-title>
                    <v-card-text>
                        <v-textarea v-model="importData" label="Paste JSON here" rows="6"></v-textarea>
                    </v-card-text>
                    <v-card-actions>
                        <v-btn color="primary" @click="doImport">Import</v-btn>
                        <v-spacer></v-spacer>
                        <v-btn text @click="importing = false">Cancel</v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>
        </v-app>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.4.27/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.5.13/dist/vuetify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuedraggable@4.1.0/dist/vuedraggable.umd.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        const { createApp } = Vue;
        const { createVuetify } = Vuetify;
        const draggable = window.vuedraggable;
        const vuetify = createVuetify();

        createApp({
            components: { draggable },
            data() {
                return {
                    url: "", list: [], current: null, expanded: true, muted: false,
                    importing: false, importData: "", player: null, timestamps: {},
                    dark: false,
                };
            },
            mounted() {
                this.list = JSON.parse(localStorage.getItem("yt_list") || "[]");
                this.timestamps = JSON.parse(localStorage.getItem("yt_time") || "{}");
                const savedTheme = localStorage.getItem("theme_dark");
                if (savedTheme !== null) {
                    this.dark = JSON.parse(savedTheme);
                } else {
                    this.dark = window.matchMedia("(prefers-color-scheme: dark)").matches;
                    localStorage.setItem("theme_dark", this.dark);
                }
                this.$vuetify.theme.name = this.dark ? "dark" : "light";
                setInterval(this.track, 3000);
            },
            methods: {
                id(url) {
                    const m = url.match(/(?:youtube\.com.*[?&]v=|youtu\.be\/)([^&\n?#]+)/);
                    return m ? m[1] : null;
                },
                thumb(url) {
                    const i = this.id(url);
                    return `https://img.youtube.com/vi/${i}/hqdefault.jpg`;
                },
                add() {
                    const i = this.id(this.url);
                    if (!i) return alert("Invalid URL");
                    if (this.list.some(v => v.id === i)) return this.url = "";
                    this.list.push({ url: this.url, id: i, favorite: false });
                    this.url = ""; this.save();
                },
                play(v) {
                    this.current = v.id;
                    this.expanded = true;
                    setTimeout(this.initPlayer, 100);
                },
                close() {
                    this.current = null;
                    if (this.player?.destroy) this.player.destroy();
                    this.player = null;
                },
                toggleTheme() {
                    this.dark = !this.dark;
                    this.$vuetify.theme.name = this.dark ? "dark" : "light";
                    localStorage.setItem("theme_dark", this.dark);
                },
                mute() {
                    this.muted = !this.muted;
                    if (this.player?.setVolume) this.player.setVolume(this.muted ? 0 : 100);
                },
                shuffle() {
                    for (let i = this.list.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [this.list[i], this.list[j]] = [this.list[j], this.list[i]];
                    }
                    this.save();
                },
                save() {
                    localStorage.setItem("yt_list", JSON.stringify(this.list));
                },
                exportList() {
                    const blob = new Blob([JSON.stringify(this.list, null, 2)], { type: "application/json" });
                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(blob);
                    a.download = "playlist.json";
                    a.click();
                },
                doImport() {
                    try {
                        const parsed = JSON.parse(this.importData);
                        parsed.forEach(v => v.id ??= this.id(v.url));
                        const unique = parsed.filter(v => !this.list.some(e => e.id === v.id));
                        this.list = [...this.list, ...unique];
                        this.save();
                        this.importing = false;
                    } catch {
                        alert("Invalid JSON");
                    }
                },
                initPlayer() {
                    if (this.player) return this.player.loadVideoById(this.current);
                    this.player = new YT.Player("yt-player", {
                        videoId: this.current,
                        playerVars: { autoplay: 1, modestbranding: 1, rel: 0 },
                        events: {
                            onReady: e => {
                                const t = this.timestamps[this.current] || 0;
                                if (t > 0) e.target.seekTo(t);
                                e.target.setVolume(this.muted ? 0 : 100);
                            },
                            onStateChange: e => {
                                if (e.data === YT.PlayerState.ENDED) this.next();
                            }
                        }
                    });
                },
                next() {
                    const i = this.list.findIndex(v => v.id === this.current);
                    const n = this.list[i + 1];
                    if (n) this.play(n);
                },
                track() {
                    if (this.player?.getCurrentTime) {
                        const t = Math.floor(this.player.getCurrentTime());
                        this.timestamps[this.current] = t;
                        localStorage.setItem("yt_time", JSON.stringify(this.timestamps));
                    }
                }
            }
        }).use(vuetify).mount("#app");
    </script>
</body>

</html>